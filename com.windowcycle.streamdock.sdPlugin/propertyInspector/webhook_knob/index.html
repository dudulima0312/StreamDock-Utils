<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Webhook Knob Settings</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 13px;
            background: #2D3142;
            color: #D8D8D8;
            margin: 0;
            padding: 10px;
        }

        .container {
            max-width: 350px;
        }

        .setting-group {
            margin-bottom: 15px;
            background: #3E4255;
            padding: 10px;
            border-radius: 5px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #9CA0AA;
        }

        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px;
            background: #2D3142;
            border: 1px solid #4A5066;
            border-radius: 3px;
            color: #D8D8D8;
            font-size: 12px;
            box-sizing: border-box;
        }

        input:focus {
            outline: none;
            border-color: #5865F2;
        }

        .info-text {
            font-size: 11px;
            color: #9CA0AA;
            margin-top: 5px;
            font-style: italic;
        }

        h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #FFFFFF;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .version-tag {
            font-size: 10px;
            background: #5865F2;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: normal;
        }

        .webhook-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 5px;
            vertical-align: middle;
        }

        .webhook-icon.left::before {
            content: "↶";
            font-size: 16px;
        }

        .webhook-icon.right::before {
            content: "↷";
            font-size: 16px;
        }

        .webhook-icon.click::before {
            content: "⬇";
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h3>
            Webhook Knob
            <span class="version-tag">v1.0</span>
        </h3>

        <div class="setting-group">
            <label>
                <span class="webhook-icon left"></span>
                Rotate Left Webhook URL
            </label>
            <input type="text" id="rotate_left_webhook" placeholder="https://example.com/webhook1">
            <div class="info-text">Triggered when knob rotates counter-clockwise</div>
        </div>

        <div class="setting-group">
            <label>
                <span class="webhook-icon right"></span>
                Rotate Right Webhook URL
            </label>
            <input type="text" id="rotate_right_webhook" placeholder="https://example.com/webhook2">
            <div class="info-text">Triggered when knob rotates clockwise</div>
        </div>

        <div class="setting-group">
            <label>
                <span class="webhook-icon click"></span>
                Click Webhook URL
            </label>
            <input type="text" id="click_webhook" placeholder="https://example.com/webhook3">
            <div class="info-text">Triggered when knob is pressed</div>
        </div>

        <div class="setting-group">
            <label>Request Timeout (seconds)</label>
            <input type="number" id="timeout" min="1" max="30" value="5">
            <div class="info-text">Maximum time to wait for webhook response</div>
        </div>
    </div>

    <script>
        let websocket = null;
        let pluginUUID = null;
        let settings = {};

        // Connect to StreamDock
        function connectElgatoStreamDeckSocket(inPort, inPluginUUID, inRegisterEvent, inInfo, inActionInfo) {
            pluginUUID = inPluginUUID;

            // Parse action info to get current settings
            if (inActionInfo) {
                const actionInfo = JSON.parse(inActionInfo);
                settings = actionInfo.payload.settings || {};
            }

            // Connect websocket
            websocket = new WebSocket('ws://127.0.0.1:' + inPort);

            websocket.onopen = function() {
                const json = {
                    event: inRegisterEvent,
                    uuid: inPluginUUID
                };
                websocket.send(JSON.stringify(json));

                // Load current settings into UI
                loadSettings();
            };

            websocket.onmessage = function(evt) {
                const jsonObj = JSON.parse(evt.data);

                if (jsonObj.event === 'didReceiveSettings') {
                    settings = jsonObj.payload.settings;
                    loadSettings();
                }
            };
        }

        // Load settings into UI
        function loadSettings() {
            document.getElementById('rotate_left_webhook').value = settings.rotate_left_webhook || '';
            document.getElementById('rotate_right_webhook').value = settings.rotate_right_webhook || '';
            document.getElementById('click_webhook').value = settings.click_webhook || '';
            document.getElementById('timeout').value = settings.timeout || 5;
        }

        // Save settings with debounce
        let saveTimeout = null;
        function saveSettings() {
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }

            saveTimeout = setTimeout(function() {
                settings.rotate_left_webhook = document.getElementById('rotate_left_webhook').value;
                settings.rotate_right_webhook = document.getElementById('rotate_right_webhook').value;
                settings.click_webhook = document.getElementById('click_webhook').value;
                settings.timeout = parseInt(document.getElementById('timeout').value);

                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    const json = {
                        "event": "setSettings",
                        "context": pluginUUID,
                        "payload": settings
                    };
                    websocket.send(JSON.stringify(json));
                }
            }, 500);
        }

        // Add event listeners when page loads
        window.addEventListener('load', function() {
            document.getElementById('rotate_left_webhook').addEventListener('input', saveSettings);
            document.getElementById('rotate_right_webhook').addEventListener('input', saveSettings);
            document.getElementById('click_webhook').addEventListener('input', saveSettings);
            document.getElementById('timeout').addEventListener('input', saveSettings);
        });
    </script>
</body>
</html>
